<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™¤å´ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 25px;
        }
        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 15px;
        }
        .upload-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        .file-input-label {
            background: #667eea;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            font-weight: 600;
        }
        .file-input-label:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .clear-button {
            background: #e74c3c;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            border: none;
            font-size: 14px;
        }
        .clear-button:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        .file-name {
            color: #666;
            font-size: 14px;
        }
        .period-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .period-label {
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
        }
        .period-button {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 13px;
        }
        .period-button:hover {
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        .period-button.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .card-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        .card-subtitle {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .chart-container.full-width {
            grid-column: 1 / -1;
        }
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        canvas {
            max-height: 400px;
        }
        .table-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-x: auto;
        }
        .cross-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 13px;
        }
        .cross-table thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 12px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            position: sticky;
            top: 0;
            z-index: 10;
            border: none;
        }
        .cross-table thead th:first-child {
            border-radius: 10px 0 0 0;
        }
        .cross-table thead th:last-child {
            border-radius: 0 10px 0 0;
        }
        .cross-table tbody tr {
            transition: all 0.3s;
        }
        .cross-table tbody tr:hover {
            background: #f8f9ff;
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        .cross-table tbody td {
            padding: 14px 12px;
            border-bottom: 1px solid #e8ecf4;
            text-align: center;
        }
        .cross-table tbody tr:last-child td {
            border-bottom: none;
        }
        .office-code {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 12px;
            display: inline-block;
            min-width: 50px;
        }
        .office-name {
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        .amount-cell {
            background: #f0f4ff;
            border-radius: 8px;
            padding: 8px;
            margin: 2px;
        }
        .amount-value {
            color: #667eea;
            font-weight: 700;
            font-size: 14px;
            display: block;
        }
        .count-value {
            color: #999;
            font-size: 11px;
            margin-top: 2px;
        }
        .total-cell {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-radius: 8px;
            padding: 8px;
            margin: 2px;
        }
        .total-amount {
            color: #d63031;
            font-weight: 800;
            font-size: 15px;
            display: block;
        }
        .total-count {
            color: #2d3436;
            font-size: 12px;
            font-weight: 600;
            margin-top: 2px;
        }
        .zero-cell {
            color: #ddd;
            font-size: 12px;
        }
        .category-repair {
            border-left: 4px solid #d63031;
        }
        .category-rental {
            border-left: 4px solid #0984e3;
        }
        .category-replacement {
            border-left: 4px solid #6c5ce7;
        }
        .category-system {
            border-left: 4px solid #e84393;
        }
        .category-other {
            border-left: 4px solid #00b894;
        }
        .legend-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #666;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .loading {
            color: #667eea;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ ä¿®ç†ãƒ»ä»£æ›¿æ©Ÿãƒ»ãƒ¬ãƒ³ã‚¿ãƒ«è²»ç”¨ é™¤å´ãƒ‡ãƒ¼ã‚¿åˆ†æ</h1>
            <div class="upload-section">
                <div class="file-input-wrapper">
                    <label for="csvFile" class="file-input-label">ğŸ“ åˆ¥ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                    <input type="file" id="csvFile" accept=".csv" />
                </div>
                <button class="clear-button" id="clearButton">ğŸ”„ æ›´æ–°ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼‰</button>
                <span class="file-name" id="fileName">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
            <div class="period-filter">
                <span class="period-label">ğŸ“… æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</span>
                <button class="period-button active" data-period="all">å…¨æœŸé–“</button>
                <div id="periodButtons"></div>
            </div>
        </div>
        <div class="summary-cards">
            <div class="card">
                <div class="card-title">ğŸ’° ç·é™¤å´é‡‘é¡</div>
                <div class="card-value" id="totalAmount">Â¥0</div>
                <div class="card-subtitle" id="totalAmountSubtitle">å…¨æœŸé–“åˆè¨ˆ</div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“‹ ç·ä»¶æ•°</div>
                <div class="card-value" id="totalCount">0ä»¶</div>
                <div class="card-subtitle" id="totalCountSubtitle">å…¨æœŸé–“åˆè¨ˆ</div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“Š å¹³å‡å˜ä¾¡</div>
                <div class="card-value" id="avgAmount">Â¥0</div>
                <div class="card-subtitle">1ä»¶ã‚ãŸã‚Š</div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ¢ å–¶æ¥­æ‰€æ•°</div>
                <div class="card-value" id="officeCount">0æ‹ ç‚¹</div>
                <div class="card-subtitle">é–¢ä¸å–¶æ¥­æ‰€</div>
            </div>
        </div>
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">ğŸ“ˆ å“ç›®åˆ†é¡åˆ¥ é‡‘é¡ãƒ»ä»¶æ•°</div>
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">ğŸ“Š å–¶æ¥­æ‰€åˆ¥ ä»¶æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
                <canvas id="officeCountChart"></canvas>
            </div>
            <div class="chart-container full-width">
                <div class="chart-title">ğŸ¢ å–¶æ¥­æ‰€åˆ¥ é™¤å´é‡‘é¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
                <canvas id="officeChart"></canvas>
            </div>
            <div class="chart-container full-width">
                <div class="chart-title">ğŸ“… æœˆåˆ¥æ¨ç§»</div>
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
        <div class="table-container">
            <div class="chart-title">ğŸ“Š å–¶æ¥­æ‰€Ã—å“ç›®åˆ†é¡ ã‚¯ãƒ­ã‚¹é›†è¨ˆ</div>
            <div class="legend-container">
                <div class="legend-item">
                    <div class="legend-color" style="background: #d63031;"></div>
                    <span>ä¿®ç†</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #0984e3;"></div>
                    <span>ãƒ¬ãƒ³ã‚¿ãƒ«</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #6c5ce7;"></div>
                    <span>ä»£æ›¿æ©Ÿ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e84393;"></div>
                    <span>ã‚·ã‚¹ãƒ†ãƒ å“</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00b894;"></div>
                    <span>ãã®ä»–</span>
                </div>
            </div>
            <table class="cross-table">
                <thead>
                    <tr>
                        <th>å–¶æ¥­æ‰€ã‚³ãƒ¼ãƒ‰</th>
                        <th>å–¶æ¥­æ‰€å</th>
                        <th>ğŸ”§ ä¿®ç†</th>
                        <th>ğŸ“¦ ãƒ¬ãƒ³ã‚¿ãƒ«</th>
                        <th>ğŸ”„ ä»£æ›¿æ©Ÿ</th>
                        <th>ğŸ’» ã‚·ã‚¹ãƒ†ãƒ å“</th>
                        <th>ğŸ“Œ ãã®ä»–</th>
                        <th>ğŸ’° åˆè¨ˆé‡‘é¡</th>
                        <th>ğŸ“‹ åˆè¨ˆä»¶æ•°</th>
                    </tr>
                </thead>
                <tbody id="crossTableBody">
                    <tr>
                        <td colspan="9" style="padding: 40px; text-align: center; color: #999;">
                            <span class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let categoryChartInstance = null;
        let officeCountChartInstance = null;
        let officeChartInstance = null;
        let monthlyChartInstance = null;
        let allData = []; // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
        let currentPeriod = 'all'; // ç¾åœ¨é¸æŠä¸­ã®æœŸ
        
        const chartColors = {
            primary: '#667eea',
            secondary: '#764ba2',
            success: '#00b894',
            warning: '#fdcb6e',
            danger: '#d63031',
            info: '#74b9ff',
            purple: '#a29bfe',
            pink: '#fd79a8'
        };
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ã§CSVã‚’èª­ã¿è¾¼ã‚€
        window.addEventListener('DOMContentLoaded', function() {
            fetch('removal_data.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    return response.text();
                })
                .then(data => {
                    parseCSV(data);
                    document.getElementById('fileName').textContent = 'removal_data.csvï¼ˆè‡ªå‹•èª­ã¿è¾¼ã¿ï¼‰';
                })
                .catch(error => {
                    console.error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    document.getElementById('fileName').textContent = 'â€»CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰‹å‹•ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„';
                    document.getElementById('crossTableBody').innerHTML = `
                        <tr>
                            <td colspan="9" style="padding: 40px; text-align: center; color: #e74c3c;">
                                removal_data.csvãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚<br>åˆ¥ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
                            </td>
                        </tr>
                    `;
                });
        });
        
        // æ‰‹å‹•ã§CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name + 'ï¼ˆæ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰';
                const reader = new FileReader();
                reader.onload = function(event) {
                    parseCSV(event.target.result);
                };
                reader.readAsText(file, 'Shift-JIS');
            }
        });
        
        // æ›´æ–°ãƒœã‚¿ãƒ³ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼‰
        document.getElementById('clearButton').addEventListener('click', function() {
            if (confirm('ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                location.reload(true);
            }
        });
        
        // CSVãƒ‘ãƒ¼ã‚¹å‡¦ç†
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            allData = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = lines[i].split(',');
                if (values.length >= 7) {
                    allData.push({
                        period: values[0]?.trim() || '',
                        month: values[1]?.trim() || '',
                        officeCode: values[2]?.trim() || '',
                        officeName: values[3]?.trim() || '',
                        requester: values[4]?.trim() || '',
                        category: values[5]?.trim() || '',
                        amount: parseInt(values[6]?.trim().replace(/[^0-9]/g, '') || '0')
                    });
                }
            }
            
            if (allData.length > 0) {
                createPeriodButtons();
                analyzeData(allData);
            } else {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        // æœŸã®ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆ
        function createPeriodButtons() {
            const periods = [...new Set(allData.map(row => row.period))].sort();
            const buttonContainer = document.getElementById('periodButtons');
            buttonContainer.innerHTML = '';
            
            periods.forEach(period => {
                const button = document.createElement('button');
                button.className = 'period-button';
                button.textContent = period;
                button.dataset.period = period;
                button.addEventListener('click', function() {
                    currentPeriod = period;
                    updateActivePeriodButton();
                    filterDataByPeriod(period);
                });
                buttonContainer.appendChild(button);
            });
            
            // å…¨æœŸé–“ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelector('[data-period="all"]').addEventListener('click', function() {
                currentPeriod = 'all';
                updateActivePeriodButton();
                analyzeData(allData);
            });
        }
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæœŸé–“ãƒœã‚¿ãƒ³ã®æ›´æ–°
        function updateActivePeriodButton() {
            document.querySelectorAll('.period-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${currentPeriod}"]`).classList.add('active');
        }
        
        // æœŸã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterDataByPeriod(period) {
            const filteredData = allData.filter(row => row.period === period);
            analyzeData(filteredData);
        }
        
        // ãƒ‡ãƒ¼ã‚¿åˆ†æå‡¦ç†
        function analyzeData(data) {
            // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰æ›´æ–°
            const totalAmount = data.reduce((sum, row) => sum + row.amount, 0);
            const totalCount = data.length;
            const avgAmount = totalCount > 0 ? Math.round(totalAmount / totalCount) : 0;
            const officeSet = new Set(data.map(row => row.officeCode));
            const officeCount = officeSet.size;
            
            document.getElementById('totalAmount').textContent = 'Â¥' + totalAmount.toLocaleString();
            document.getElementById('totalCount').textContent = totalCount.toLocaleString() + 'ä»¶';
            document.getElementById('avgAmount').textContent = 'Â¥' + avgAmount.toLocaleString();
            document.getElementById('officeCount').textContent = officeCount + 'æ‹ ç‚¹';
            
            // ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            const subtitle = currentPeriod === 'all' ? 'å…¨æœŸé–“åˆè¨ˆ' : currentPeriod + 'åˆè¨ˆ';
            document.getElementById('totalAmountSubtitle').textContent = subtitle;
            document.getElementById('totalCountSubtitle').textContent = subtitle;
            
            // å“ç›®åˆ†é¡åˆ¥é›†è¨ˆ
            const categoryData = {};
            data.forEach(row => {
                if (!categoryData[row.category]) {
                    categoryData[row.category] = { amount: 0, count: 0 };
                }
                categoryData[row.category].amount += row.amount;
                categoryData[row.category].count += 1;
            });
            
            // å–¶æ¥­æ‰€åˆ¥é›†è¨ˆ
            const officeData = {};
            data.forEach(row => {
                const key = row.officeCode + '|' + row.officeName;
                if (!officeData[key]) {
                    officeData[key] = { amount: 0, count: 0, code: row.officeCode, name: row.officeName };
                }
                officeData[key].amount += row.amount;
                officeData[key].count += 1;
            });
            
            // æœˆåˆ¥é›†è¨ˆ
            const monthData = {};
            data.forEach(row => {
                if (!monthData[row.month]) {
                    monthData[row.month] = { amount: 0, count: 0 };
                }
                monthData[row.month].amount += row.amount;
                monthData[row.month].count += 1;
            });
            
            // å–¶æ¥­æ‰€Ã—å“ç›®åˆ†é¡ã‚¯ãƒ­ã‚¹é›†è¨ˆ
            const crossData = {};
            data.forEach(row => {
                const officeKey = row.officeCode + '|' + row.officeName;
                if (!crossData[officeKey]) {
                    crossData[officeKey] = {
                        code: row.officeCode,
                        name: row.officeName,
                        categories: {}
                    };
                }
                if (!crossData[officeKey].categories[row.category]) {
                    crossData[officeKey].categories[row.category] = { amount: 0, count: 0 };
                }
                crossData[officeKey].categories[row.category].amount += row.amount;
                crossData[officeKey].categories[row.category].count += 1;
            });
            
            // ã‚°ãƒ©ãƒ•ã¨ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
            updateCategoryChart(categoryData);
            updateOfficeCharts(officeData);
            updateMonthlyChart(monthData);
            updateCrossTable(crossData);
        }
        
        // å“ç›®åˆ†é¡åˆ¥ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
        function updateCategoryChart(categoryData) {
            const labels = Object.keys(categoryData);
            const amounts = labels.map(cat => Math.round(categoryData[cat].amount / 10000));
            const counts = labels.map(cat => categoryData[cat].count);
            
            if (categoryChartInstance) categoryChartInstance.destroy();
            
            categoryChartInstance = new Chart(document.getElementById('categoryChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é‡‘é¡ï¼ˆä¸‡å††ï¼‰',
                        data: amounts,
                        backgroundColor: chartColors.primary,
                        yAxisID: 'y'
                    }, {
                        label: 'ä»¶æ•°',
                        data: counts,
                        backgroundColor: chartColors.warning,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'é‡‘é¡ï¼ˆä¸‡å††ï¼‰' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'ä»¶æ•°' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }
        
        // å–¶æ¥­æ‰€åˆ¥ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
        function updateOfficeCharts(officeData) {
            const offices = Object.values(officeData).sort((a, b) => b.amount - a.amount);
            const labels = offices.map(o => o.name);
            const amounts = offices.map(o => Math.round(o.amount / 10000));
            const counts = offices.map(o => o.count);
            
            const colors = [
                chartColors.primary, chartColors.secondary, chartColors.success,
                chartColors.warning, chartColors.danger, chartColors.info,
                chartColors.purple, chartColors.pink, '#95a5a6', '#7f8c8d',
                '#e67e22', '#16a085', '#2980b9', '#8e44ad', '#c0392b'
            ];
            
            // ä»¶æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰
            if (officeCountChartInstance) officeCountChartInstance.destroy();
            
            officeCountChartInstance = new Chart(document.getElementById('officeCountChart'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + 'ä»¶';
                                }
                            }
                        }
                    }
                }
            });
            
            // é‡‘é¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆæ¨ªæ£’ã‚°ãƒ©ãƒ•ï¼‰
            if (officeChartInstance) officeChartInstance.destroy();
            
            officeChartInstance = new Chart(document.getElementById('officeChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é™¤å´é‡‘é¡ï¼ˆä¸‡å††ï¼‰',
                        data: amounts,
                        backgroundColor: colors
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'é‡‘é¡ï¼ˆä¸‡å††ï¼‰' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        // æœˆåˆ¥æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
        function updateMonthlyChart(monthData) {
            const sortedMonths = Object.keys(monthData).sort();
            const labels = sortedMonths.map(m => {
                const month = m.substring(4, 6);
                return parseInt(month) + 'æœˆ';
            });
            const amounts = sortedMonths.map(m => Math.round(monthData[m].amount / 10000));
            const counts = sortedMonths.map(m => monthData[m].count);
            
            if (monthlyChartInstance) monthlyChartInstance.destroy();
            
            monthlyChartInstance = new Chart(document.getElementById('monthlyChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é‡‘é¡ï¼ˆä¸‡å††ï¼‰',
                        data: amounts,
                        borderColor: chartColors.primary,
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'ä»¶æ•°',
                        data: counts,
                        borderColor: chartColors.warning,
                        backgroundColor: 'rgba(253, 203, 110, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                },
                plugins: [{
                    id: 'customDataLabels',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        const dataset = chart.data.datasets[1];
                        const meta = chart.getDatasetMeta(1);
                        meta.data.forEach(function(point, index) {
                            const data = dataset.data[index];
                            if (data > 0) {
                                ctx.fillStyle = '#d63031';
                                ctx.font = 'bold 11px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'bottom';
                                ctx.fillText(data + 'ä»¶', point.x, point.y - 5);
                            }
                        });
                    }
                }]
            });
        }
        
        // ã‚¯ãƒ­ã‚¹é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        function updateCrossTable(crossData) {
            const tbody = document.getElementById('crossTableBody');
            tbody.innerHTML = '';
            
            const offices = Object.values(crossData).sort((a, b) => {
                const totalA = Object.values(a.categories).reduce((sum, cat) => sum + cat.amount, 0);
                const totalB = Object.values(b.categories).reduce((sum, cat) => sum + cat.amount, 0);
                return totalB - totalA;
            });
            
            const allCategories = ['ä¿®ç†', 'ãƒ¬ãƒ³ã‚¿ãƒ«', 'ä»£æ›¿æ©Ÿ', 'ã‚·ã‚¹ãƒ†ãƒ å“', 'ãã®ä»–'];
            
            offices.forEach(office => {
                const tr = document.createElement('tr');
                
                // å–¶æ¥­æ‰€ã‚³ãƒ¼ãƒ‰
                const tdCode = document.createElement('td');
                tdCode.innerHTML = `<span class="office-code">${office.code}</span>`;
                tr.appendChild(tdCode);
                
                // å–¶æ¥­æ‰€å
                const tdName = document.createElement('td');
                tdName.innerHTML = `<span class="office-name">${office.name}</span>`;
                tr.appendChild(tdName);
                
                // å„å“ç›®åˆ†é¡
                let totalAmount = 0;
                let totalCount = 0;
                
                allCategories.forEach(category => {
                    const td = document.createElement('td');
                    td.className = `category-${getCategoryClass(category)}`;
                    
                    if (office.categories[category]) {
                        const cat = office.categories[category];
                        totalAmount += cat.amount;
                        totalCount += cat.count;
                        td.innerHTML = `
                            <div class="amount-cell">
                                <span class="amount-value">Â¥${cat.amount.toLocaleString()}</span>
                                <span class="count-value">${cat.count}ä»¶</span>
                            </div>
                        `;
                    } else {
                        td.innerHTML = '<span class="zero-cell">Â¥0 (0ä»¶)</span>';
                    }
                    tr.appendChild(td);
                });
                
                // åˆè¨ˆé‡‘é¡
                const tdTotal = document.createElement('td');
                tdTotal.innerHTML = `
                    <div class="total-cell">
                        <span class="total-amount">Â¥${totalAmount.toLocaleString()}</span>
                        <span class="total-count">${totalCount}ä»¶</span>
                    </div>
                `;
                tr.appendChild(tdTotal);
                
                // åˆè¨ˆä»¶æ•°
                const tdCount = document.createElement('td');
                tdCount.innerHTML = `<strong style="font-size: 16px; color: #667eea;">${totalCount}ä»¶</strong>`;
                tr.appendChild(tdCount);
                
                tbody.appendChild(tr);
            });
        }
        
        // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¯ãƒ©ã‚¹åå–å¾—
        function getCategoryClass(category) {
            const map = {
                'ä¿®ç†': 'repair',
                'ãƒ¬ãƒ³ã‚¿ãƒ«': 'rental',
                'ä»£æ›¿æ©Ÿ': 'replacement',
                'ã‚·ã‚¹ãƒ†ãƒ å“': 'system',
                'ãã®ä»–': 'other'
            };
            return map[category] || 'other';
        }
    </script>
</body>
</html>